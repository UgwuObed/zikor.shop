name: Deploy App

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.HOST }} << 'EOF'
            set -e  # Exit on any error
            
            echo "=== Starting Node.js deployment ==="
            
            # Fix git ownership issue
            git config --global --add safe.directory /var/www/zikor.shop
            
            # Change to project directory
            cd /var/www/zikor.shop
            
            echo "=== Force updating to latest version ==="
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            echo "=== Cleaning old files ==="
            rm -rf node_modules
            rm -rf .next
            
            echo "=== Installing dependencies ==="
            npm install --legacy-peer-deps
            
            echo "=== Building application ==="
            npm run build
            
            echo "=== Managing PM2 process ==="
            # Stop PM2 process if running
            pm2 stop zikor || echo "Process wasn't running"
            pm2 delete zikor || echo "Process didn't exist"
            
            # Ensure proper permissions for the built app
            chmod -R 755 /var/www/zikor.shop
            
            # Start fresh PM2 process
            pm2 start npm --name "zikor" -- start
            
            # Save PM2 configuration
            pm2 save
            
            # Show PM2 status
            pm2 status
            
            echo "=== Deployment completed successfully ==="
          EOF